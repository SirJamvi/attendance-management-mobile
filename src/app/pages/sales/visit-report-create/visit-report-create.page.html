<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/sales/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Laporan Kunjungan</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">

  <form (ngSubmit)="onSubmit()">
    
    <!-- BAGIAN 1: INFORMASI TEMPAT -->
    <ion-list-header>
      <ion-label>Informasi Tempat</ion-label>
    </ion-list-header>
    
    <ion-item class="rounded-item ion-margin-bottom">
      <ion-label position="stacked">Nama Tempat / Bisnis <ion-text color="danger">*</ion-text></ion-label>
      <ion-input [(ngModel)]="placeName" name="placeName" placeholder="Contoh: Toko Jaya Abadi" required></ion-input>
    </ion-item>

    <ion-item class="rounded-item ion-margin-bottom">
      <ion-label position="stacked">Alamat Lengkap <ion-text color="danger">*</ion-text></ion-label>
      <ion-textarea [(ngModel)]="address" name="address" rows="2" placeholder="Jl. Jendral Sudirman No. 1..." required></ion-textarea>
    </ion-item>

    <ion-row>
      <ion-col size="6">
        <ion-item class="rounded-item">
          <ion-label position="stacked">Nama PIC <ion-text color="danger">*</ion-text></ion-label>
          <ion-input [(ngModel)]="picName" name="picName" placeholder="Bpk. Budi" required></ion-input>
        </ion-item>
      </ion-col>
      <ion-col size="6">
        <ion-item class="rounded-item">
          <ion-label position="stacked">No. HP PIC <ion-text color="danger">*</ion-text></ion-label>
          <ion-input [(ngModel)]="picPhone" name="picPhone" type="tel" placeholder="081..." required></ion-input>
        </ion-item>
      </ion-col>
    </ion-row>

    <!-- BAGIAN 2: HASIL KUNJUNGAN -->
    <ion-list-header class="ion-margin-top">
      <ion-label>Hasil Kunjungan</ion-label>
    </ion-list-header>

    <ion-item class="rounded-item ion-margin-bottom">
      <ion-label position="stacked">Status Hasil <ion-text color="danger">*</ion-text></ion-label>
      <ion-select [(ngModel)]="result" name="result" placeholder="Pilih Hasil" interface="action-sheet" required>
        <ion-select-option *ngFor="let res of visitResults" [value]="res.value">
          {{ res.label }}
        </ion-select-option>
      </ion-select>
    </ion-item>

    <ion-item class="rounded-item ion-margin-bottom">
      <ion-label position="stacked">Catatan Tambahan (Opsional)</ion-label>
      <ion-textarea [(ngModel)]="notes" name="notes" rows="3" placeholder="Catatan khusus atau tindak lanjut..."></ion-textarea>
    </ion-item>

    <!-- BAGIAN 3: BUKTI FOTO & GPS -->
    <ion-list-header class="ion-margin-top">
      <ion-label>Bukti Kunjungan</ion-label>
    </ion-list-header>

    <div class="camera-section ion-margin-bottom">
      <ion-label color="medium" class="ion-text-wrap ion-margin-bottom d-block small-text">
        Ambil foto lokasi/bersama PIC. GPS akan dicatat otomatis.
      </ion-label>
      
      <!-- Komponen Kamera -->
      <app-camera-view (photoTaken)="handlePhoto($event)"></app-camera-view>

      <!-- Status GPS -->
      <div *ngIf="photoData && !locationData" class="ion-text-center ion-padding-top">
        <ion-spinner name="dots" color="primary"></ion-spinner>
        <p class="small-text">Sedang mengambil lokasi GPS...</p>
      </div>
      
      <div *ngIf="photoData && locationData" class="ion-text-center ion-padding-top text-success">
        <ion-icon name="location-sharp"></ion-icon>
        <span class="small-text">Lokasi Terkunci: {{ locationData.latitude | number:'1.4-4' }}, {{ locationData.longitude | number:'1.4-4' }}</span>
      </div>
    </div>

    <!-- Tombol Submit -->
    <ion-button expand="block" type="submit" size="large" class="ion-margin-top" [disabled]="isSubmitting || !photoData || !locationData">
      <span *ngIf="!isSubmitting">Submit Laporan</span>
      <ion-spinner *ngIf="isSubmitting"></ion-spinner>
    </ion-button>

  </form>

</ion-content>